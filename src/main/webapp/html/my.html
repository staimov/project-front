<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src=https://code.jquery.com/jquery-3.6.0.min.js></script>
    <link href="/css/my.css" rel="stylesheet">

    <!--Bootstrap CSS-->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css"
          rel="stylesheet"
          integrity="sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ"
          crossorigin="anonymous">

    <title>RPG</title>
</head>
<body onload="updateAll()">

    <!--Bootstrap JS-->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-ENjdO4Dr2bkBIFxQpeoTz1HIcje39Wm4jDKdf19U8gI4ddQ3GYNS7NTKfAdVQSZe"
            crossorigin="anonymous"></script>

    <h1>RPG admin panel</h1>

    <h4>Accounts</h4>


    <div class="row row-cols-auto mb-3 align-items-center">
        <label for="account_count_per_page_select" class="col">Items per page</label>
        <div class="col">
            <select id="account_count_per_page_select" onchange="updateAll()"
                    class="form-select" aria-label="Default select example">
                <option selected>3</option>
                <option value="5">5</option>
                <option value="10">10</option>
                <option value="20">20</option>
            </select>
        </div>
    </div>


    <div>
        <table id="account_table" class="table table-bordered border-primary">
            <tr>
                <th>#</th>
                <th>Name</th>
                <th>Title</th>
                <th>Race</th>
                <th>Profession</th>
                <th>Level</th>
                <th>Birthday</th>
                <th>Banned</th>
            </tr>
        </table>
    </div>

    <nav>
        <ul id="account_paging_buttons" class="pagination">
        </ul>
    </nav>

    <script>
        let countTotal;
        let countPerPage;
        let countPages;

        function updateAll() {
            updateCounts();
            preparePagingButtons();
            showAccounts();
        }

        function updateCounts() {
            countTotal = getAccountCount();
            console.log('countTotal: ' + countTotal);
            countPerPage = $('#account_count_per_page_select').val();
            if (countPerPage == null) {
                countPerPage = 3;
            }
            console.log('countPerPage:" ' + countPerPage);
            countPages = Math.ceil(countTotal / countPerPage);
            console.log('countPages: ' + countPages);
        }

        function showAccounts(pageNumber) {
            if (pageNumber == null) {
                pageNumber = 0;
            }

            let url = '/rest/players?' +
                'pageNumber=' + pageNumber + '&' +
                'pageSize=' + countPerPage;

            console.log('Query url: ' + url);

            $('tr:has(td)').remove();

            $.get(url, function (response) {
                $.each(response, function (i, item) {
                    $('<tr>').html(
                        '<td>' + item.id + '</td>' +
                        '<td>' + item.name + '</td>' +
                        '<td>' + item.title + '</td>' +
                        '<td>' + item.race + '</td>' +
                        '<td>' + item.profession + '</td>' +
                        '<td>' + item.level + '</td>' +
                        '<td>' + new Date(item.birthday).toLocaleDateString() + '</td>' +
                        '<td>' + item.banned + '</td>'
                    ).appendTo('#account_table');
                });
            });
        }

        function preparePagingButtons() {
            $('li.page-item').remove()
            for (let i = 0; i < countPages; i++) {
                let buttonTag;
                if (i == 0) {
                    buttonTag = '<li class="page-item"><a class="page-link active" href="#">' + (i + 1) + '</a></li>';
                } else {
                    buttonTag = '<li class="page-item"><a class="page-link" href="#">' + (i + 1) + '</a></li>';
                }
                $('#account_paging_buttons').append(buttonTag);
            }

            $('ul.pagination li a').on('click',function(e){
                e.preventDefault();
                $('a.page-link.active').removeClass('active');
                $(this).addClass('active');
                let buttonIndex = parseInt($(this).text());
                if (buttonIndex == null) {
                    buttonIndex = 1;
                }
                showAccounts(buttonIndex - 1);
            });
        }

        function getAccountCount() {
            let url = '/rest/players/count';
            let count = 0;

            $.ajax({
                url: url,
                async: false,
                success: function (result) {
                    count = parseInt(result);
                }
            });

            return count;
        }

    </script>

</body>
</html>
